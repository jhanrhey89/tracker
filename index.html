<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0d1b2a">
<title>Racing Pigeon Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d1b2a;--card:rgba(17,40,70,0.85);--accent:#00e5ff;--green:#39ff14;--orange:#ff6b35;--gold:#ffd700;--silver:#c0c0c0;--bronze:#cd7f32;--text:#d0eaff;--muted:#4a7090;--border:rgba(0,229,255,0.15);--danger:#ef4444;--purple:#a855f7;--admin:#f59e0b;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Exo 2',sans-serif;background:var(--bg);min-height:100vh;color:var(--text);-webkit-tap-highlight-color:transparent;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 15% 5%,rgba(0,150,200,0.1) 0%,transparent 60%),radial-gradient(ellipse 60% 40% at 85% 95%,rgba(57,255,20,0.05) 0%,transparent 60%);pointer-events:none;z-index:0;}
#login-page{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:var(--bg);padding:20px;flex-direction:column;}
#login-page.hidden{display:none;}
.login-glow{position:absolute;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(0,229,255,0.07) 0%,transparent 70%);animation:pglow 3s ease-in-out infinite;pointer-events:none;}
@keyframes pglow{0%,100%{transform:scale(1);opacity:.7;}50%{transform:scale(1.2);opacity:1;}}
.login-box{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:40px 34px;width:100%;max-width:390px;backdrop-filter:blur(20px);position:relative;box-shadow:0 0 60px rgba(0,229,255,0.08),0 24px 60px rgba(0,0,0,0.6);animation:sUp .6s cubic-bezier(.16,1,.3,1);}
@keyframes sUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo .bird{font-size:52px;display:block;animation:float 3s ease-in-out infinite;margin-bottom:8px;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.login-logo h1{font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;letter-spacing:3px;color:var(--accent);text-transform:uppercase;}
.login-logo p{font-size:11px;color:var(--muted);letter-spacing:1px;margin-top:3px;}
.l-group{margin-bottom:16px;}
.l-group label{display:block;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:7px;}
.l-group input{width:100%;padding:13px 15px;background:rgba(0,229,255,0.05);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:15px;font-family:'Exo 2',sans-serif;transition:all .3s;outline:none;}
.l-group input:focus{border-color:var(--accent);background:rgba(0,229,255,0.09);box-shadow:0 0 0 3px rgba(0,229,255,0.09);}
.login-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#0088aa);border:none;border-radius:10px;color:#0d1b2a;font-size:15px;font-weight:800;font-family:'Rajdhani',sans-serif;letter-spacing:2px;cursor:pointer;margin-top:6px;transition:all .25s;text-transform:uppercase;}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,229,255,0.3);}
.login-btn:active{transform:scale(.98);}
.login-err{color:var(--danger);font-size:12px;text-align:center;margin-top:8px;min-height:18px;font-weight:600;}
.login-footer{text-align:center;color:var(--muted);font-size:10px;margin-top:16px;letter-spacing:1px;}
#app{display:none;min-height:100vh;}
.topbar{background:rgba(13,27,42,0.97);backdrop-filter:blur(16px);padding:11px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;}
.topbar-title{font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700;letter-spacing:2px;color:var(--accent);}
.topbar-right{display:flex;align-items:center;gap:8px;}
.admin-crown{background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.35);color:var(--admin);padding:5px 10px;border-radius:7px;font-size:11px;font-weight:700;letter-spacing:1px;}
.coins-display{background:rgba(255,215,0,0.15);border:1px solid rgba(255,215,0,0.35);color:#ffd700;padding:5px 10px;border-radius:7px;font-size:11px;font-weight:700;letter-spacing:1px;}
.topbar-user{font-size:11px;color:var(--muted);}
.logout-btn{background:rgba(239,68,68,.13);border:1px solid rgba(239,68,68,.3);color:var(--danger);padding:6px 12px;border-radius:7px;font-size:11px;cursor:pointer;font-family:'Exo 2',sans-serif;transition:all .2s;letter-spacing:.5px;}
.logout-btn:hover{background:rgba(239,68,68,.22);}
nav{background:rgba(13,27,42,0.92);backdrop-filter:blur(12px);display:flex;border-bottom:1px solid var(--border);position:sticky;top:55px;z-index:150;overflow-x:auto;}
nav::-webkit-scrollbar{display:none;}
nav button{flex:1;min-width:68px;padding:12px 5px;border:none;background:transparent;color:var(--muted);font-size:9px;cursor:pointer;transition:all .25s;font-weight:700;font-family:'Rajdhani',sans-serif;letter-spacing:1px;text-transform:uppercase;border-bottom:3px solid transparent;white-space:nowrap;}
nav button:hover{color:var(--text);background:rgba(0,229,255,0.04);}
nav button.active{color:var(--accent);border-bottom:3px solid var(--accent);background:rgba(0,229,255,0.06);}
nav button.admin-tab{color:var(--admin) !important;opacity:.7;}
nav button.admin-tab.active{color:var(--admin) !important;border-bottom-color:var(--admin) !important;background:rgba(245,158,11,0.07) !important;opacity:1;}
.container{max-width:820px;margin:0 auto;padding:15px;padding-bottom:60px;position:relative;z-index:1;}
.page{display:none;animation:fadeIn .35s;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.card{background:var(--card);border:1px solid var(--border);border-radius:15px;padding:18px;margin-bottom:15px;backdrop-filter:blur(12px);}
.card h2{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;letter-spacing:2px;color:var(--accent);margin-bottom:14px;text-transform:uppercase;}
.card h3{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;color:var(--text);margin-bottom:11px;text-transform:uppercase;}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.info-row:last-child{border-bottom:none;}
.info-label{color:var(--muted);font-size:12px;}
.info-value{color:var(--text);font-weight:600;font-size:12px;text-align:right;max-width:58%;}
.live-speed-card{background:linear-gradient(135deg,rgba(57,255,20,0.12),rgba(0,229,255,0.07));border:1px solid rgba(57,255,20,0.28);border-radius:15px;padding:20px;text-align:center;margin-bottom:15px;}
.ls-label{font-family:'Rajdhani',sans-serif;font-size:10px;letter-spacing:3px;color:var(--green);text-transform:uppercase;margin-bottom:7px;display:block;}
.live-speed-num{font-family:'Rajdhani',sans-serif;font-size:56px;font-weight:700;color:var(--green);line-height:1;text-shadow:0 0 30px rgba(57,255,20,0.5);}
.live-speed-unit{font-size:11px;color:rgba(255,255,255,0.45);margin-top:4px;}
.live-speed-kmh{font-size:16px;font-weight:600;color:var(--green);margin-top:4px;}
.arrival-card{background:rgba(102,126,234,0.09);border:1px solid rgba(102,126,234,0.2);border-radius:15px;padding:18px;margin-bottom:15px;}
.arrival-card h3{font-family:'Rajdhani',sans-serif;color:#818cf8;font-size:13px;letter-spacing:2px;text-align:center;margin-bottom:12px;text-transform:uppercase;}
.arrival-log{margin-top:16px;}
.arrival-log h3{font-family:'Rajdhani',sans-serif;font-size:13px;color:var(--green);letter-spacing:2px;margin-bottom:9px;text-transform:uppercase;}
.log-table-wrap{overflow-x:auto;border-radius:11px;border:1px solid var(--border);}
.log-table{width:100%;border-collapse:collapse;font-size:11px;}
.log-table th{background:rgba(0,229,255,0.08);color:var(--accent);font-family:'Rajdhani',sans-serif;font-size:9px;letter-spacing:2px;text-transform:uppercase;padding:10px 11px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
.log-table td{padding:9px 11px;border-bottom:1px solid rgba(255,255,255,0.04);color:var(--text);white-space:nowrap;font-size:11px;}
.log-table tr:last-child td{border-bottom:none;}
.log-table tr:hover td{background:rgba(0,229,255,0.03);}
@keyframes rowFlash{0%{background:rgba(57,255,20,0.18);}100%{background:transparent;}}
.new-row td{animation:rowFlash .9s ease;}
.rank-badge{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;font-weight:800;font-size:10px;font-family:'Rajdhani',sans-serif;}
.rank-1{background:var(--gold);color:#000;}
.rank-2{background:var(--silver);color:#000;}
.rank-3{background:var(--bronze);color:#fff;}
.rank-n{background:rgba(255,255,255,0.1);color:var(--muted);}
.spd-g{color:var(--green);font-weight:700;}
.ela-b{color:var(--accent);}
.no-log{text-align:center;padding:22px;color:var(--muted);font-size:12px;}
.form-group{margin-bottom:15px;}
.form-group label{display:block;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:11px 13px;background:rgba(0,229,255,0.04);border:1px solid var(--border);border-radius:9px;color:var(--text);font-size:14px;font-family:'Exo 2',sans-serif;transition:all .3s;outline:none;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent);background:rgba(0,229,255,0.07);box-shadow:0 0 0 3px rgba(0,229,255,0.08);}
.form-group textarea{resize:vertical;min-height:75px;}
.form-group select option{background:#142233;color:var(--text);}
.btn{width:100%;padding:13px;border:none;border-radius:9px;font-size:13px;font-weight:700;font-family:'Rajdhani',sans-serif;cursor:pointer;transition:all .25s;letter-spacing:2px;text-transform:uppercase;}
.btn:active{transform:scale(.98);}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white;}
.btn-primary:hover{box-shadow:0 5px 18px rgba(102,126,234,0.32);}
.btn-success{background:linear-gradient(135deg,var(--green),#16a34a);color:#0d1b2a;margin-top:10px;}
.btn-success:hover{box-shadow:0 5px 18px rgba(57,255,20,0.22);}
.btn-admin{background:linear-gradient(135deg,var(--admin),#d97706);color:#0d1b2a;margin-top:10px;}
.btn-admin:hover{box-shadow:0 5px 18px rgba(245,158,11,0.28);}
.btn-danger-sm{padding:7px 13px;background:rgba(239,68,68,.13);border:1px solid rgba(239,68,68,.3);color:var(--danger);border-radius:7px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .2s;}
.btn-danger-sm:hover{background:rgba(239,68,68,.22);}
.btn-approve{padding:7px 13px;background:rgba(57,255,20,.13);border:1px solid rgba(57,255,20,.3);color:var(--green);border-radius:7px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .2s;}
.btn-approve:hover{background:rgba(57,255,20,.22);}
.speed-forecast{background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:13px;padding:15px;margin-top:15px;}
.speed-forecast h3{text-align:center;margin-bottom:12px;color:var(--green);font-family:'Rajdhani',sans-serif;font-size:13px;letter-spacing:2px;text-transform:uppercase;}
.speed-item{display:flex;justify-content:space-between;align-items:center;padding:7px 11px;background:rgba(255,255,255,0.03);margin-bottom:5px;border-radius:7px;font-size:11px;border:1px solid rgba(255,255,255,0.04);}
.speed-val{font-weight:700;color:var(--green);font-family:'Rajdhani',sans-serif;font-size:13px;}
.sunset-card{background:linear-gradient(135deg,rgba(249,115,22,0.13),rgba(220,38,38,0.13));border:1px solid rgba(249,115,22,0.25);border-radius:13px;padding:15px;margin-top:15px;}
.sunset-card h3{text-align:center;margin-bottom:11px;font-family:'Rajdhani',sans-serif;color:#fb923c;letter-spacing:2px;font-size:13px;text-transform:uppercase;}
.pigeon-card{background:rgba(17,40,70,0.7);border:1px solid rgba(57,255,20,0.16);border-left:4px solid var(--green);border-radius:11px;padding:14px;margin-bottom:11px;transition:all .25s;}
.pigeon-card:hover{background:rgba(17,40,70,0.9);}
.pigeon-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:7px;}
.pigeon-name{font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700;color:var(--green);}
.pigeon-band{font-size:11px;color:var(--muted);margin-top:2px;}
.pigeon-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:7px;}
.pigeon-detail{font-size:11px;}
.pigeon-detail span{color:var(--muted);}
.race-card{background:rgba(102,126,234,0.08);border:1px solid rgba(102,126,234,0.18);border-left:4px solid #667eea;border-radius:11px;padding:15px;margin-bottom:11px;}
.race-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:11px;}
.race-title{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:#818cf8;}
.ev-badge{padding:3px 9px;border-radius:20px;font-size:9px;letter-spacing:1px;text-transform:uppercase;}
.active-badge{background:rgba(57,255,20,0.1);color:var(--green);border:1px solid rgba(57,255,20,0.28);}
.archived-badge{background:rgba(255,255,255,0.05);color:var(--muted);border:1px solid rgba(255,255,255,0.1);}
.pigeon-checkbox{margin-bottom:10px;padding:12px;background:rgba(0,229,255,0.04);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;}
.pigeon-checkbox:hover{background:rgba(0,229,255,0.08);border-color:rgba(0,229,255,0.25);}
.pigeon-checkbox input[type="checkbox"]{margin:0;cursor:pointer;width:20px;height:20px;accent-color:var(--green);}
.pigeon-checkbox label{cursor:pointer;font-size:13px;flex:1;display:flex;align-items:center;gap:10px;font-weight:600;}
.checkbox-container{max-height:280px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;padding:12px;background:rgba(0,0,0,0.2);}
.event-history-card{background:rgba(13,27,42,0.75);border:1px solid var(--border);border-radius:15px;padding:18px;margin-bottom:16px;}
.event-title{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:#818cf8;margin-bottom:3px;}
.event-meta{font-size:10px;color:var(--muted);margin-bottom:13px;line-height:1.8;}
.top3-row{display:flex;gap:7px;margin-bottom:13px;}
.podium-card{flex:1;background:rgba(0,0,0,0.2);border-radius:9px;padding:9px 7px;text-align:center;border:1px solid rgba(255,255,255,0.06);}
.podium-card.p1{border-color:rgba(255,215,0,0.28);background:rgba(255,215,0,0.06);}
.podium-card.p2{border-color:rgba(192,192,192,0.28);background:rgba(192,192,192,0.04);}
.podium-card.p3{border-color:rgba(205,127,50,0.28);background:rgba(205,127,50,0.04);}
.podium-icon{font-size:16px;display:block;margin-bottom:4px;}
.podium-name{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.podium-speed{font-size:10px;color:var(--green);font-weight:600;margin-top:2px;}
.rank-row{display:flex;align-items:center;gap:11px;padding:12px 14px;background:rgba(17,40,70,0.5);border-radius:9px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);transition:all .2s;}
.rank-row:hover{background:rgba(17,40,70,0.8);}
.rank-info{flex:1;min-width:0;}
.rank-pname{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;color:var(--text);}
.rank-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.rank-stats{text-align:right;flex-shrink:0;}
.rank-avg{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--green);}
.rank-races-lbl{font-size:9px;color:var(--muted);}
.admin-banner{background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(217,119,6,0.1));border:1px solid rgba(245,158,11,0.3);border-radius:13px;padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px;}
.admin-banner .crown{font-size:28px;}
.admin-banner h2{font-family:'Rajdhani',sans-serif;font-size:18px;color:var(--admin);letter-spacing:2px;margin-bottom:2px;}
.admin-banner p{font-size:11px;color:var(--muted);}
.account-row{display:flex;align-items:center;justify-content:space-between;padding:13px 15px;background:rgba(17,40,70,0.6);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;gap:10px;}
.account-info{flex:1;min-width:0;}
.account-name{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;color:var(--text);}
.account-meta{font-size:10px;color:var(--muted);margin-top:2px;}
.account-badge{padding:3px 9px;border-radius:12px;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;}
.badge-admin{background:rgba(245,158,11,0.18);color:var(--admin);border:1px solid rgba(245,158,11,0.35);}
.badge-user{background:rgba(0,229,255,0.1);color:var(--accent);border:1px solid rgba(0,229,255,0.25);}
.stats-pill{display:inline-flex;gap:12px;flex-wrap:wrap;margin-top:4px;}
.stat-chip{font-size:10px;color:var(--muted);}
.stat-chip strong{color:var(--text);}
.transfer-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:11px;margin-top:16px;}
.transfer-btn-card{padding:26px 13px;background:rgba(17,40,70,0.6);border:1px solid var(--border);border-radius:13px;cursor:pointer;text-align:center;transition:all .25s;color:var(--text);}
.transfer-btn-card:hover{background:rgba(0,229,255,0.06);border-color:rgba(0,229,255,0.28);transform:translateY(-2px);}
.transfer-btn-card:active{transform:scale(.97);}
.transfer-btn-card i{font-size:30px;display:block;margin-bottom:8px;}
.transfer-btn-card span{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;text-transform:uppercase;}
.data-preview{background:rgba(0,0,0,0.33);border-radius:9px;padding:14px;margin-top:13px;max-height:300px;overflow-y:auto;text-align:left;}
.data-preview pre{color:var(--green);font-family:'Courier New',monospace;font-size:10px;white-space:pre-wrap;word-break:break-all;}
.status-msg{margin-top:13px;padding:12px;border-radius:8px;text-align:center;font-weight:700;font-family:'Rajdhani',sans-serif;letter-spacing:1px;font-size:13px;}
.s-ok{background:rgba(57,255,20,0.09);border:1px solid var(--green);color:var(--green);}
.s-err{background:rgba(239,68,68,0.09);border:1px solid var(--danger);color:var(--danger);}
.request-card{background:rgba(17,40,70,0.6);border:1px solid var(--border);border-radius:10px;padding:13px;margin-bottom:10px;}
.request-pending{border-left:4px solid var(--orange);}
.request-approved{border-left:4px solid var(--green);}
.request-rejected{border-left:4px solid var(--danger);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:rgba(255,255,255,0.02);}
::-webkit-scrollbar-thumb{background:var(--muted);border-radius:4px;}
@media(max-width:600px){.container{padding:10px;}.top3-row{flex-direction:column;}.transfer-grid{grid-template-columns:1fr;}.pigeon-grid{grid-template-columns:1fr;}nav button{font-size:8px;padding:10px 3px;}.login-box{padding:26px 20px;}}
</style>
</head>
<body>
<div id="login-page">
  <div class="login-glow"></div>
  <div class="login-box">
    <div class="login-logo">
      <span class="bird">üïäÔ∏è</span>
      <h1>Pigeon Tracker</h1>
      <p>RACING MANAGEMENT SYSTEM</p>
    </div>
    <div class="l-group">
      <label>Username</label>
      <input type="text" id="login-user" placeholder="Enter username" autocomplete="username" autocapitalize="none">
    </div>
    <div class="l-group">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="Enter password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="login-btn" onclick="doLogin()">LOGIN</button>
    <div class="login-err" id="login-err"></div>
    <div class="login-footer">AUTHORIZED USERS ONLY</div>
  </div>
</div>
<div id="app">
  <div class="topbar">
    <div class="topbar-title">üïäÔ∏è PIGEON TRACKER</div>
    <div class="topbar-right">
      <span class="admin-crown" id="admin-crown" style="display:none;">üëë ADMIN</span>
      <span class="coins-display" id="coins-display" style="display:none;">üí∞ <span id="coin-count">0</span> COINS</span>
      <span class="topbar-user" id="topbar-user"></span>
      <button class="logout-btn" onclick="doLogout()">LOGOUT</button>
    </div>
  </div>
  <nav id="main-nav">
    <button class="nav-btn active" onclick="showPage(0)">üìä Forecast</button>
    <button class="nav-btn" onclick="showPage(1)">üïäÔ∏è Pigeons</button>
    <button class="nav-btn" onclick="showPage(2)">üìã History</button>
    <button class="nav-btn" onclick="showPage(3)">üèÜ Rankings</button>
    <button class="nav-btn" onclick="showPage(4)">üíæ Data</button>
    <button class="nav-btn" id="coins-nav-btn" style="display:none;" onclick="showPage(5)">üí∞ Coins</button>
    <button class="nav-btn admin-tab" id="admin-nav-btn" style="display:none;" onclick="showPage(6)">üëë Admin</button>
  </nav>
  <div class="container">
    <div class="page active" id="page-0">
      <div style="text-align:center;margin-bottom:16px;">
        <div style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;letter-spacing:4px;color:var(--accent);">FORECASTING</div>
        <div style="font-size:10px;color:var(--muted);letter-spacing:2px;margin-top:2px;">LIVE RACE MONITOR</div>
      </div>
      <div class="live-speed-card">
        <span class="ls-label">Live Speed (since release)</span>
        <div class="live-speed-num" id="live-speed">0</div>
        <div class="live-speed-unit">meters / minute</div>
        <div class="live-speed-kmh" id="live-speed-kmh">0 km/h</div>
      </div>
      <div class="card">
        <h3>Active Event Info</h3>
        <div class="info-row"><span class="info-label">Event Name</span><span class="info-value" id="rel-name">‚Äî</span></div>
        <div class="info-row"><span class="info-label">Location</span><span class="info-value" id="rel-loc">‚Äî</span></div>
        <div class="info-row"><span class="info-label">Distance</span><span class="info-value" id="rel-dist">‚Äî</span></div>
        <div class="info-row"><span class="info-label">Release Time</span><span class="info-value" id="rel-time">‚Äî</span></div>
      </div>
      <div class="arrival-card">
        <h3>Record Pigeon Arrival</h3>
        <div class="form-group">
          <label>Select Pigeon</label>
          <select id="arriving-pigeon"><option value="">‚Äî Start Forecasting First ‚Äî</option></select>
        </div>
        <button class="btn btn-success" id="arrive-btn" onclick="recordArrival()">üèÅ PIGEON ARRIVED</button>
      </div>
      <div class="arrival-log">
        <h3>üèÅ Arrival Log</h3>
        <div class="log-table-wrap">
          <table class="log-table">
            <thead><tr><th>Rank</th><th>Pigeon</th><th>Arrival Time</th><th>m/min</th><th>km/h</th><th>Total Time</th></tr></thead>
            <tbody id="arrival-log-body"><tr><td colspan="6" class="no-log">Start forecasting then record arrivals.</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="speed-forecast">
        <h3>Speed ‚Üí Arrival Time Forecast</h3>
        <div id="speed-list"><div class="no-log" style="font-size:11px;">Click "Start Live Tracking" to generate.</div></div>
      </div>
      <div class="sunset-card">
        <h3>üåÖ Sunset / Sunrise</h3>
        <div class="info-row"><span class="info-label">Sunset (approx.)</span><span class="info-value" id="sunset-time">‚Äî</span></div>
        <div class="info-row"><span class="info-label">Sunrise Next Day</span><span class="info-value" id="sunrise-time">‚Äî</span></div>
      </div>
      <button class="btn btn-primary" onclick="startForecasting()" style="margin-top:16px;">‚ñ∂ START LIVE TRACKING</button>
    </div>
    <div class="page" id="page-1">
      <div class="card">
        <h2>Add Racing Pigeon</h2>
        <form id="pigeon-form" onsubmit="addPigeon(event)">
          <div class="form-group"><label>Pigeon Name</label><input type="text" id="pn-name" required placeholder="e.g., Thunderwing"></div>
          <div class="form-group"><label>Ring Band Number</label><input type="text" id="pn-band" required placeholder="e.g., PH-2024-12345"></div>
          <div class="form-group">
            <label>Color</label>
            <select id="pn-color" required>
              <option value="">Select color</option>
              <option>Blue</option><option>Red</option><option>White</option>
              <option>Black</option><option>Checker</option><option>Grizzle</option><option>Mealy</option>
            </select>
          </div>
          <div class="form-group"><label>Age (years)</label><input type="number" id="pn-age" min="0" step="0.1" placeholder="e.g., 2.5"></div>
          <div class="form-group"><label>Notes</label><textarea id="pn-notes" placeholder="Additional info..."></textarea></div>
          <button type="submit" class="btn btn-primary">ADD PIGEON</button>
        </form>
      </div>
      <div class="card">
        <h2>Create Race / Training Event</h2>
        <div style="background:rgba(57,255,20,0.06);border:1px solid rgba(57,255,20,0.18);border-radius:9px;padding:9px 13px;margin-bottom:14px;font-size:11px;color:var(--green);" id="event-cost-info">‚ÑπÔ∏è Events auto-archive at midnight. Each event costs 5 coins.</div>
        <form id="race-form" onsubmit="createRace(event)">
          <div class="form-group"><label>Type</label><select id="ev-type"><option value="Training">Training</option><option value="Race">Race</option></select></div>
          <div class="form-group"><label>Event Name</label><input type="text" id="ev-name" required placeholder="e.g., Gumaca Sprint #3"></div>
          <div class="form-group"><label>Release Location</label><input type="text" id="ev-loc" required placeholder="e.g., GUMACA"></div>
          <div class="form-group"><label>Air Distance to Loft (KM)</label><input type="number" id="ev-dist" step="0.01" required placeholder="e.g., 172.21"></div>
          <div class="form-group"><label>Release Date & Time</label><input type="datetime-local" id="ev-dt" required></div>
          <div class="form-group">
            <label>Select Pigeons (Check to add)</label>
            <div class="checkbox-container" id="pigeon-checkboxes"></div>
          </div>
          <button type="submit" class="btn btn-success">CREATE EVENT</button>
        </form>
      </div>
      <div class="card">
        <h2>My Pigeons</h2>
        <div id="pigeons-container"><div class="no-log">No pigeons added yet.</div></div>
      </div>
      <div class="card">
        <h2>Active Events</h2>
        <div id="races-container"><div class="no-log">No active events.</div></div>
      </div>
    </div>
    <div class="page" id="page-2">
      <div class="card" style="margin-bottom:13px;">
        <h2>Event History</h2>
        <div style="font-size:10px;color:var(--muted);letter-spacing:1px;">All events with arrival records and podium rankings</div>
      </div>
      <div id="history-container"><div class="no-log" style="padding:28px;">No events yet.</div></div>
    </div>
    <div class="page" id="page-3">
      <div class="card" style="margin-bottom:13px;">
        <h2>üèÜ All-Time Rankings</h2>
        <div style="font-size:10px;color:var(--muted);letter-spacing:1px;">Average speed compiled across all your events</div>
      </div>
      <div id="rankings-container"><div class="no-log" style="padding:28px;">No race data yet.</div></div>
    </div>
    <div class="page" id="page-4">
      <div class="card" style="text-align:center;">
        <h2>Data Transfer</h2>
        <div style="font-size:11px;color:var(--muted);">Your private account data only</div>
        <div class="transfer-grid">
          <div class="transfer-btn-card" onclick="exportData()"><i>üì§</i><span>Export</span></div>
          <div class="transfer-btn-card" onclick="document.getElementById('import-file').click()"><i>üì•</i><span>Import</span></div>
          <div class="transfer-btn-card" onclick="clearMyData()"><i>üóëÔ∏è</i><span>Clear Mine</span></div>
          <div class="transfer-btn-card" onclick="showDataPreview()"><i>üëÅÔ∏è</i><span>Preview</span></div>
        </div>
        <input type="file" id="import-file" style="display:none" accept=".json" onchange="importData(event)">
        <div id="status-message"></div>
        <div id="data-preview-container"></div>
      </div>
    </div>
    <div class="page" id="page-5">
      <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,165,0,0.08));">
        <h2 style="color:#ffd700;">üí∞ My Coins</h2>
        <div style="font-size:72px;font-family:'Rajdhani',sans-serif;font-weight:700;color:#ffd700;text-shadow:0 0 20px rgba(255,215,0,0.5);margin:20px 0;">
          <span id="coins-big-display">0</span>
        </div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">COINS AVAILABLE</div>
        <div style="background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.2);border-radius:10px;padding:15px;margin-bottom:20px;">
          <div style="font-size:12px;color:var(--text);margin-bottom:8px;">üí° <strong>Each event costs 5 coins</strong></div>
          <div style="font-size:11px;color:var(--muted);">You need coins to create racing events</div>
        </div>
      </div>
      <div class="card">
        <h2>Request Coins</h2>
        <div style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.25);border-radius:10px;padding:15px;margin-bottom:20px;">
          <div style="font-size:13px;color:var(--text);margin-bottom:12px;"><strong>üì± Send payment to GCash:</strong></div>
          <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:12px;margin-bottom:12px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:5px;">GCash Number:</div>
            <div style="font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:#ffd700;letter-spacing:2px;">09123456789</div>
            <div style="font-size:11px;color:var(--muted);margin-top:5px;">Name: JHANREY</div>
          </div>
          <div style="font-size:11px;color:var(--green);margin-bottom:8px;">üíµ <strong>Coin Prices:</strong></div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
            <div style="background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:18px;font-weight:700;color:#ffd700;">50 COINS</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;">‚Ç± 50.00</div>
            </div>
            <div style="background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:18px;font-weight:700;color:#ffd700;">100 COINS</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;">‚Ç± 90.00</div>
            </div>
            <div style="background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:18px;font-weight:700;color:#ffd700;">200 COINS</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;">‚Ç± 170.00</div>
            </div>
            <div style="background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:18px;font-weight:700;color:#ffd700;">500 COINS</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;">‚Ç± 400.00</div>
            </div>
          </div>
        </div>
        <form id="coin-request-form" onsubmit="requestCoins(event)">
          <div class="form-group">
            <label>Amount of Coins Requesting</label>
            <input type="number" id="coins-amount" required placeholder="e.g., 50" min="10">
          </div>
          <div class="form-group">
            <label>GCash Reference Number</label>
            <input type="text" id="gcash-ref" required placeholder="e.g., 1234567890">
          </div>
          <div class="form-group">
            <label>Amount Sent (‚Ç±)</label>
            <input type="number" id="amount-sent" required placeholder="e.g., 50.00" step="0.01">
          </div>
          <button type="submit" class="btn btn-success">üì§ SUBMIT REQUEST</button>
        </form>
        <div id="coin-request-status"></div>
      </div>
      <div class="card">
        <h2>üìú My Coin Requests</h2>
        <div id="my-requests-container"><div class="no-log">No requests yet.</div></div>
      </div>
    </div>
    <div class="page" id="page-6">
      <div class="admin-banner">
        <span class="crown">üëë</span>
        <div>
          <h2>Admin Panel</h2>
          <p>Manage accounts, approve coin requests, add coins manually</p>
        </div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,165,0,0.08));">
        <h2 style="color:#ffd700;">üí∞ Pending Coin Requests</h2>
        <div id="admin-requests-container"><div class="no-log">No pending requests.</div></div>
      </div>
      <div class="card">
        <h2>‚ûï Manually Add Coins</h2>
        <form id="admin-coin-form" onsubmit="adminAddCoins(event)">
          <div class="form-group">
            <label>Select User</label>
            <select id="admin-user-select" required>
              <option value="">Select a user...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Coins to Add</label>
            <input type="number" id="admin-coins-amount" required placeholder="e.g., 100" min="1">
          </div>
          <div class="form-group">
            <label>Reason (optional)</label>
            <input type="text" id="admin-coin-reason" placeholder="e.g., Bonus, Promotion">
          </div>
          <button type="submit" class="btn btn-admin">üí∞ ADD COINS</button>
        </form>
        <div id="admin-coin-status"></div>
      </div>
      <div class="card">
        <h2>Create New Account</h2>
        <form id="create-acc-form" onsubmit="createAccount(event)">
          <div class="form-group"><label>Username</label><input type="text" id="new-username" required placeholder="e.g., racer01" autocapitalize="none"></div>
          <div class="form-group"><label>Password</label><input type="password" id="new-password" required placeholder="Enter password"></div>
          <div class="form-group"><label>Confirm Password</label><input type="password" id="new-password2" required placeholder="Repeat password"></div>
          <div class="form-group"><label>Initial Coins</label><input type="number" id="initial-coins" value="0" min="0" placeholder="Starting coins (default: 0)"></div>
          <button type="submit" class="btn btn-admin">CREATE ACCOUNT</button>
        </form>
        <div id="create-acc-status"></div>
      </div>
      <div class="card">
        <h2>All Accounts</h2>
        <div id="accounts-container"><div class="no-log">Loading...</div></div>
      </div>
      <div class="card">
        <h2>Global Overview</h2>
        <div id="global-stats"><div class="no-log">Loading...</div></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, get, update, remove, onValue, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBIxkxJ6OUQL9dAMrUjhxMNL3C1u_PfJOM",
  authDomain: "pigeontracker-ab0b2.firebaseapp.com",
  databaseURL: "https://pigeontracker-ab0b2-default-rtdb.firebaseapp.com",
  projectId: "pigeontracker-ab0b2",
  storageBucket: "pigeontracker-ab0b2.firebasestorage.app",
  messagingSenderId: "640069843490",
  appId: "1:640069843490:web:8344f0ac170d4244f1287b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ADMIN_USER='jhanrhey89';
const BUILTIN=[
  {username:'jhanrhey89',password:'12345',isAdmin:true,builtIn:true,coins:999999},
  {username:'yaku',password:'12345',isAdmin:false,builtIn:true,coins:50}
];

let currentUser=sessionStorage.getItem('pt_user')||null;
let liveInterval=null,activeForecastRaceId=null,pigeons=[],races=[];
let userCoins=0,isAdmin=false;

window.doLogin=async function(){
  const u=document.getElementById('login-user').value.trim().toLowerCase();
  const p=document.getElementById('login-pass').value;
  
  try{
    const accountsSnap=await get(ref(db,'accounts'));
    let accounts=[];
    if(accountsSnap.exists()){
      const data=accountsSnap.val();
      accounts=Object.keys(data).map(k=>({username:k,...data[k]}));
    }
    accounts=[...BUILTIN,...accounts.filter(a=>!BUILTIN.find(b=>b.username===a.username))];
    
    const m=accounts.find(a=>a.username===u&&a.password===p);
    if(m){
      currentUser=m.username;
      isAdmin=m.isAdmin||false;
      userCoins=m.coins||0;
      sessionStorage.setItem('pt_user',currentUser);
      
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('app').style.display='block';
      document.getElementById('topbar-user').textContent='üë§ '+currentUser.toUpperCase();
      
      if(isAdmin){
        document.getElementById('admin-crown').style.display='inline-flex';
        document.getElementById('admin-nav-btn').style.display='flex';
        document.getElementById('coins-display').style.display='none';
        document.getElementById('coins-nav-btn').style.display='none';
        document.getElementById('event-cost-info').innerHTML='‚ÑπÔ∏è Events auto-archive at midnight. Admin has unlimited events.';
      }else{
        document.getElementById('admin-crown').style.display='none';
        document.getElementById('admin-nav-btn').style.display='none';
        document.getElementById('coins-display').style.display='inline-flex';
        document.getElementById('coins-nav-btn').style.display='flex';
        document.getElementById('coin-count').textContent=userCoins;
      }
      
      await initApp();
      listenToCoins();
    }else{
      const e=document.getElementById('login-err');
      e.textContent='‚úñ Invalid username or password';
      document.getElementById('login-pass').value='';
      setTimeout(()=>e.textContent='',3000);
    }
  }catch(err){
    console.error(err);
    alert('Login error. Please try again.');
  }
};

window.doLogout=function(){
  sessionStorage.removeItem('pt_user');
  if(liveInterval)clearInterval(liveInterval);
  currentUser=null;activeForecastRaceId=null;isAdmin=false;userCoins=0;
  document.getElementById('app').style.display='none';
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('login-user').value='';
  document.getElementById('login-pass').value='';
  document.getElementById('login-err').textContent='';
  showPage(0);
};

function listenToCoins(){
  if(isAdmin)return;
  onValue(ref(db,`accounts/${currentUser}/coins`),snap=>{
    if(snap.exists()){
      userCoins=snap.val();
      document.getElementById('coin-count').textContent=userCoins;
      document.getElementById('coins-big-display').textContent=userCoins;
    }
  });
}

async function initApp(){
  await loadUserData();
  autoArchive();
  renderAll();
  if(!isAdmin)loadMyRequests();
}

async function loadUserData(){
  try{
    const [pigeonsSnap,racesSnap]=await Promise.all([
      get(ref(db,`users/${currentUser}/pigeons`)),
      get(ref(db,`users/${currentUser}/races`))
    ]);
    pigeons=pigeonsSnap.exists()?Object.values(pigeonsSnap.val()):[];
    races=racesSnap.exists()?Object.values(racesSnap.val()):[];
  }catch(err){
    console.error(err);
    pigeons=[];races=[];
  }
}

async function saveUserData(){
  try{
    await Promise.all([
      set(ref(db,`users/${currentUser}/pigeons`),pigeons.length?pigeons:null),
      set(ref(db,`users/${currentUser}/races`),races.length?races:null)
    ]);
  }catch(err){
    console.error(err);
  }
}

function autoArchive(){
  const n=new Date();let c=false;
  races.forEach(r=>{
    if(r.status==='active'){
      const d=new Date(r.releaseDateTime),e=new Date(d);e.setHours(23,59,59,999);
      if(n>e){r.status='archived';c=true;}
    }
  });
  if(c)saveUserData();
}

window.showPage=function(i){
  document.querySelectorAll('.page').forEach((p,x)=>p.classList.toggle('active',x===i));
  document.querySelectorAll('.nav-btn').forEach((b,x)=>b.classList.toggle('active',x===i));
  if(i===1){renderPigeons();renderRaces();updatePigeonCheckboxes();}
  if(i===2)renderHistory();
  if(i===3)renderRankings();
  if(i===5&&!isAdmin){document.getElementById('coins-big-display').textContent=userCoins;loadMyRequests();}
  if(i===6&&isAdmin)renderAdminPage();
};

function renderAll(){
  renderPigeons();renderRaces();updatePigeonCheckboxes();
  renderHistory();renderRankings();
  if(activeForecastRaceId){
    const r=races.find(x=>x.id===activeForecastRaceId);
    if(r)refreshArrivalLog(r);
  }
}

function fmtDT(d){
  const t=new Date(d);
  return`${String(t.getMonth()+1).padStart(2,'0')}/${String(t.getDate()).padStart(2,'0')}/${t.getFullYear()} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
}

function fmtElapsed(m){
  const h=Math.floor(m/60),mm=Math.floor(m%60),s=Math.floor((m*60)%60);
  return`${h}h ${mm}m ${s}s`;
}

function getActiveRace(){return races.find(r=>r.status==='active')||null;}

window.startForecasting=function(){
  autoArchive();
  const r=getActiveRace();
  if(!r){alert('No active event found.\n\nCreate one in the Pigeons tab first.');return;}
  activeForecastRaceId=r.id;
  
  document.getElementById('rel-name').textContent=r.name;
  document.getElementById('rel-loc').textContent=r.location;
  document.getElementById('rel-dist').textContent=r.distance+' KM';
  document.getElementById('rel-time').textContent=fmtDT(r.releaseDateTime);
  
  const s=document.getElementById('arriving-pigeon');
  s.innerHTML='<option value="">‚Äî Select a pigeon ‚Äî</option>';
  r.pigeons.forEach(p=>s.innerHTML+=`<option value="${JSON.stringify({id:p.id,name:p.name,distance:r.distance,releaseTime:r.releaseDateTime}).replace(/"/g,'&quot;')}">${p.name}</option>`);
  
  const t=new Date(r.releaseDateTime),sp=[1600,1500,1400,1300,1200,1100,1000,900,800,700,600,500],sl=document.getElementById('speed-list');
  sl.innerHTML='';
  sp.forEach(v=>{
    const m=(r.distance*1000)/v,at=new Date(t.getTime()+m*60000);
    sl.innerHTML+=`<div class="speed-item"><span class="speed-val">${v} m/min</span><span style="color:var(--muted);font-size:11px;">${fmtDT(at)}</span></div>`;
  });
  
  const ss=new Date(t);ss.setHours(18,0,0,0);
  const sr=new Date(t);sr.setDate(sr.getDate()+1);sr.setHours(5,30,0,0);
  document.getElementById('sunset-time').textContent=fmtDT(ss);
  document.getElementById('sunrise-time').textContent=fmtDT(sr);
  
  if(liveInterval)clearInterval(liveInterval);
  liveInterval=setInterval(()=>{
    const n=new Date(),e=(n-t)/60000;
    if(e>0){
      document.getElementById('live-speed').textContent=Math.round((r.distance*1000)/e);
      document.getElementById('live-speed-kmh').textContent=(r.distance/(e/60)).toFixed(2)+' km/h';
    }
  },1000);
  
  refreshArrivalLog(r);
  alert('‚úÖ Forecasting started!\nEvent: '+r.name+'\nDistance: '+r.distance+' KM');
};

window.recordArrival=async function(){
  const s=document.getElementById('arriving-pigeon');
  if(!s.value){alert('Please select a pigeon first.');return;}
  const p=JSON.parse(s.value.replace(/&quot;/g,'"')),n=new Date(),rel=new Date(p.releaseTime),em=(n-rel)/60000;
  if(em<=0){alert('Arrival time is before release time!');return;}
  const mm=Math.round((p.distance*1000)/em),km=parseFloat((p.distance/(em/60)).toFixed(2)),r=races.find(x=>x.id===activeForecastRaceId)||getActiveRace();
  if(!r){alert('No active race. Please start forecasting first.');return;}
  if(!r.arrivals)r.arrivals=[];
  if(r.arrivals.find(a=>a.pigeonId===p.id)&&!confirm(p.name+' already recorded.\nRecord another arrival?'))return;
  r.arrivals.push({pigeonId:p.id,pigeonName:p.name,arrivalTime:n.toISOString(),speedMMin:mm,speedKmH:km,elapsedMinutes:em});
  await saveUserData();
  refreshArrivalLog(r,true);
  renderHistory();renderRankings();
  s.value='';
  const b=document.getElementById('arrive-btn'),o=b.textContent;
  b.textContent='‚úÖ '+p.name+' ‚Äî '+mm+' m/min';
  b.style.background='linear-gradient(135deg,#0ea5e9,#0088aa)';
  setTimeout(()=>{b.textContent=o;b.style.background='';},2500);
};

function refreshArrivalLog(r,isNew=false){
  const t=document.getElementById('arrival-log-body');
  if(!r||!r.arrivals||r.arrivals.length===0){t.innerHTML='<tr><td colspan="6" class="no-log">No arrivals recorded yet.</td></tr>';return;}
  const so=[...r.arrivals].sort((a,b)=>b.speedMMin-a.speedMMin),la=r.arrivals[r.arrivals.length-1].arrivalTime;
  t.innerHTML=so.map((a,i)=>{
    const rc=i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-n',iN=isNew&&a.arrivalTime===la;
    return`<tr class="${iN?'new-row':''}"><td><span class="rank-badge ${rc}">${i+1}</span></td><td><strong>${a.pigeonName}</strong></td><td>${fmtDT(a.arrivalTime)}</td><td class="spd-g">${a.speedMMin}</td><td class="spd-g">${a.speedKmH}</td><td class="ela-b">${fmtElapsed(a.elapsedMinutes)}</td></tr>`;
  }).join('');
}

window.addPigeon=async function(e){
  e.preventDefault();
  const p={id:Date.now(),name:document.getElementById('pn-name').value.trim(),ringBand:document.getElementById('pn-band').value.trim(),color:document.getElementById('pn-color').value,age:document.getElementById('pn-age').value||'N/A',notes:document.getElementById('pn-notes').value||'‚Äî',addedDate:new Date().toISOString()};
  pigeons.push(p);
  await saveUserData();
  document.getElementById('pigeon-form').reset();
  renderPigeons();updatePigeonCheckboxes();
  alert('‚úÖ '+p.name+' added!');
};

function renderPigeons(){
  const c=document.getElementById('pigeons-container');
  if(pigeons.length===0){c.innerHTML='<div class="no-log">No pigeons added yet.</div>';return;}
  c.innerHTML=pigeons.map(p=>`<div class="pigeon-card"><div class="pigeon-header"><div><div class="pigeon-name">üïäÔ∏è ${p.name}</div><div class="pigeon-band">${p.ringBand}</div></div><button class="btn-danger-sm" onclick="deletePigeon(${p.id})">Delete</button></div><div class="pigeon-grid"><div class="pigeon-detail"><span>Color:</span> ${p.color}</div><div class="pigeon-detail"><span>Age:</span> ${p.age} yrs</div><div class="pigeon-detail" style="grid-column:1/-1"><span>Notes:</span> ${p.notes}</div></div></div>`).join('');
}

window.deletePigeon=async function(id){
  if(!confirm('Delete this pigeon?'))return;
  pigeons=pigeons.filter(p=>p.id!==id);
  await saveUserData();
  renderPigeons();updatePigeonCheckboxes();
};

function updatePigeonCheckboxes(){
  const c=document.getElementById('pigeon-checkboxes');
  if(pigeons.length===0){c.innerHTML='<div class="no-log" style="padding:10px;">Add pigeons first</div>';return;}
  c.innerHTML=pigeons.map(p=>`<div class="pigeon-checkbox"><input type="checkbox" id="p${p.id}" value="${p.id}"><label for="p${p.id}"><strong>${p.name}</strong> <span style="color:var(--muted);font-size:11px;">(${p.ringBand})</span></label></div>`).join('');
}

window.createRace=async function(e){
  e.preventDefault();
  autoArchive();
  
  if(!isAdmin){
    if(userCoins<5){
      alert('‚ùå Insufficient coins!\n\nYou need 5 coins to create an event.\nCurrent balance: '+userCoins+' coins\n\nGo to the Coins tab to request more.');
      return;
    }
  }
  
  const cb=Array.from(document.querySelectorAll('#pigeon-checkboxes input[type="checkbox"]:checked'));
  if(cb.length===0){alert('Select at least one pigeon.');return;}
  
  const r={id:Date.now(),type:document.getElementById('ev-type').value,name:document.getElementById('ev-name').value.trim(),location:document.getElementById('ev-loc').value.trim(),distance:parseFloat(document.getElementById('ev-dist').value),releaseDateTime:document.getElementById('ev-dt').value,pigeons:cb.map(c=>{const p=pigeons.find(x=>x.id===parseInt(c.value));return{id:p.id,name:p.name};}),arrivals:[],status:'active',createdDate:new Date().toISOString()};
  
  races.push(r);
  await saveUserData();
  
  if(!isAdmin){
    userCoins-=5;
    await update(ref(db,`accounts/${currentUser}`),{coins:userCoins});
    document.getElementById('coin-count').textContent=userCoins;
  }
  
  document.getElementById('race-form').reset();
  document.querySelectorAll('#pigeon-checkboxes input[type="checkbox"]').forEach(x=>x.checked=false);
  renderRaces();renderHistory();
  alert('‚úÖ '+r.type+' event "'+r.name+'" created!'+(isAdmin?'':'\n\nüí∞ 5 coins deducted. Balance: '+userCoins));
};

function renderRaces(){
  const c=document.getElementById('races-container'),a=races.filter(r=>r.status==='active');
  if(a.length===0){c.innerHTML='<div class="no-log">No active events.</div>';return;}
  c.innerHTML=a.map(r=>`<div class="race-card"><div class="race-hdr"><div class="race-title">${r.name}</div><span class="ev-badge active-badge">${r.type}</span></div><div class="info-row"><span class="info-label">Location</span><span class="info-value">${r.location}</span></div><div class="info-row"><span class="info-label">Distance</span><span class="info-value">${r.distance} KM</span></div><div class="info-row"><span class="info-label">Release Time</span><span class="info-value">${fmtDT(r.releaseDateTime)}</span></div><div class="info-row"><span class="info-label">Pigeons</span><span class="info-value">${r.pigeons.map(p=>p.name).join(', ')}</span></div><div class="info-row"><span class="info-label">Arrivals</span><span class="info-value">${r.arrivals?r.arrivals.length:0} recorded</span></div><button class="btn-danger-sm" style="width:100%;margin-top:9px;padding:9px;" onclick="editEventPigeons(${r.id})">‚úèÔ∏è Edit Pigeons</button><button class="btn-danger-sm" style="width:100%;margin-top:5px;padding:9px;" onclick="deleteRace(${r.id})">Delete Event</button></div>`).join('');
}

window.editEventPigeons=async function(rid){
  const r=races.find(x=>x.id===rid);
  if(!r)return;
  const c=document.getElementById('pigeon-checkboxes');
  c.innerHTML=pigeons.map(p=>{
    const ch=r.pigeons.find(x=>x.id===p.id)?'checked':'';
    return`<div class="pigeon-checkbox"><input type="checkbox" id="ep${p.id}" value="${p.id}" ${ch}><label for="ep${p.id}"><strong>${p.name}</strong> <span style="color:var(--muted);font-size:11px;">(${p.ringBand})</span></label></div>`;
  }).join('');
  showPage(1);
  setTimeout(()=>{
    const m=confirm('Edit pigeon selection for "'+r.name+'"?\n\nCheck/uncheck pigeons above, then click OK to save changes.');
    if(m){
      const cb=Array.from(document.querySelectorAll('#pigeon-checkboxes input[type="checkbox"]:checked'));
      if(cb.length===0){alert('Must have at least one pigeon.');updatePigeonCheckboxes();return;}
      r.pigeons=cb.map(x=>{const p=pigeons.find(y=>y.id===parseInt(x.value));return{id:p.id,name:p.name};});
      saveUserData();
      renderRaces();
      alert('‚úÖ Pigeons updated!');
    }
    updatePigeonCheckboxes();
  },100);
};

window.deleteRace=async function(id){
  if(!confirm('Delete this event and all its arrival records?'))return;
  races=races.filter(r=>r.id!==id);
  await saveUserData();
  renderRaces();renderHistory();renderRankings();
};

function renderHistory(){
  const c=document.getElementById('history-container');
  if(races.length===0){c.innerHTML='<div class="no-log" style="padding:28px;">No events yet.</div>';return;}
  const s=[...races].sort((a,b)=>new Date(b.releaseDateTime)-new Date(a.releaseDateTime));
  c.innerHTML=s.map(r=>{
    const a=r.arrivals||[],t=[...a].sort((x,y)=>y.speedMMin-x.speedMMin),t3=t.slice(0,3),pI=['ü•á','ü•à','ü•â'],pC=['p1','p2','p3'];
    const pod=t3.length>0?`<div class="top3-row">${t3.map((x,i)=>`<div class="podium-card ${pC[i]}"><span class="podium-icon">${pI[i]}</span><div class="podium-name">${x.pigeonName}</div><div class="podium-speed">${x.speedMMin} m/min</div></div>`).join('')}</div>`:'<div style="color:var(--muted);font-size:11px;margin-bottom:11px;">No arrivals recorded.</div>';
    const rows=t.length>0?t.map((x,i)=>{
      const rc=i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-n';
      return`<tr><td><span class="rank-badge ${rc}">${i+1}</span></td><td>${x.pigeonName}</td><td>${fmtDT(x.arrivalTime)}</td><td class="spd-g">${x.speedMMin}</td><td class="spd-g">${x.speedKmH}</td><td class="ela-b">${fmtElapsed(x.elapsedMinutes)}</td></tr>`;
    }).join(''):'<tr><td colspan="6" class="no-log">No arrivals</td></tr>';
    return`<div class="event-history-card"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;flex-wrap:wrap;gap:5px;"><div class="event-title">${r.name}</div><span class="ev-badge ${r.status==='active'?'active-badge':'archived-badge'}">${r.status==='active'?'üü¢ Active':'üìÅ Archived'}</span></div><div class="event-meta">üìç ${r.location} | üìè ${r.distance} KM | üïê ${fmtDT(r.releaseDateTime)} | üè∑Ô∏è ${r.type}<br>üë• ${r.pigeons.map(p=>p.name).join(', ')}</div>${pod}<div class="log-table-wrap"><table class="log-table"><thead><tr><th>Rank</th><th>Pigeon</th><th>Arrival Time</th><th>m/min</th><th>km/h</th><th>Total Time</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
  }).join('');
}

function renderRankings(){
  const c=document.getElementById('rankings-container'),st={};
  races.forEach(r=>(r.arrivals||[]).forEach(a=>{
    if(!st[a.pigeonId])st[a.pigeonId]={name:a.pigeonName,speeds:[],count:0};
    st[a.pigeonId].speeds.push(a.speedMMin);
    st[a.pigeonId].count++;
  }));
  const l=Object.values(st).map(s=>({name:s.name,count:s.count,avg:Math.round(s.speeds.reduce((a,b)=>a+b,0)/s.speeds.length),best:Math.max(...s.speeds),worst:Math.min(...s.speeds)})).sort((a,b)=>b.avg-a.avg);
  if(l.length===0){c.innerHTML='<div class="no-log" style="padding:28px;">No data yet.</div>';return;}
  const m=['ü•á','ü•à','ü•â'],rc=['rank-1','rank-2','rank-3'];
  c.innerHTML=l.map((p,i)=>{
    const r=i<3?rc[i]:'rank-n',md=i<3?m[i]:'';
    return`<div class="rank-row"><span class="rank-badge ${r}">${i+1}</span><div class="rank-info"><div class="rank-pname">${md} ${p.name}</div><div class="rank-sub">${p.count} event${p.count>1?'s':''} | Best: <span style="color:var(--green)">${p.best}</span> | Worst: <span style="color:var(--orange)">${p.worst}</span> m/min</div></div><div class="rank-stats"><div class="rank-avg">${p.avg}</div><div class="rank-races-lbl">avg m/min</div></div></div>`;
  }).join('');
}

window.exportData=function(){
  const d={account:currentUser,pigeons,races,exportDate:new Date().toISOString()},b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=`pigeon-${currentUser}-${Date.now()}.json`;a.click();
  showStatus('Data exported!',true,'status-message');
};

window.importData=async function(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=async v=>{
    try{
      const d=JSON.parse(v.target.result);
      if(d.pigeons)pigeons=d.pigeons;
      if(d.races)races=d.races;
      await saveUserData();
      renderAll();
      showStatus('Imported!',true,'status-message');
    }catch{showStatus('Invalid file.',false,'status-message');}
  };
  r.readAsText(f);e.target.value='';
};

window.clearMyData=async function(){
  if(!confirm('Clear ALL your pigeons and race data? Cannot be undone.'))return;
  pigeons=[];races=[];
  await set(ref(db,`users/${currentUser}`),null);
  renderAll();showStatus('Your data cleared.',true,'status-message');
};

window.showDataPreview=function(){
  document.getElementById('data-preview-container').innerHTML=`<div class="data-preview"><pre>${JSON.stringify({pigeons,races},null,2)}</pre></div>`;
};

function showStatus(m,ok,elId){
  const d=document.getElementById(elId);
  d.className='status-msg '+(ok?'s-ok':'s-err');d.textContent=m;
  setTimeout(()=>{d.className='';d.textContent='';},3500);
}

window.requestCoins=async function(e){
  e.preventDefault();
  const amt=parseInt(document.getElementById('coins-amount').value);
  const ref_num=document.getElementById('gcash-ref').value.trim();
  const amtSent=parseFloat(document.getElementById('amount-sent').value);
  
  const req={
    id:Date.now(),
    username:currentUser,
    coinsRequested:amt,
    gcashRef:ref_num,
    amountSent:amtSent,
    status:'pending',
    requestDate:new Date().toISOString()
  };
  
  try{
    await push(ref(db,'coinRequests'),req);
    document.getElementById('coin-request-form').reset();
    showStatus('‚úÖ Request submitted! Admin will review it.',true,'coin-request-status');
    setTimeout(()=>loadMyRequests(),500);
  }catch(err){
    showStatus('Error submitting request.',false,'coin-request-status');
  }
};

async function loadMyRequests(){
  try{
    const snap=await get(ref(db,'coinRequests'));
    if(!snap.exists()){
      document.getElementById('my-requests-container').innerHTML='<div class="no-log">No requests yet.</div>';
      return;
    }
    const data=snap.val();
    const myReqs=Object.keys(data).map(k=>({firebaseKey:k,...data[k]})).filter(r=>r.username===currentUser).sort((a,b)=>b.requestDate.localeCompare(a.requestDate));
    
    if(myReqs.length===0){
      document.getElementById('my-requests-container').innerHTML='<div class="no-log">No requests yet.</div>';
      return;
    }
    
    document.getElementById('my-requests-container').innerHTML=myReqs.map(r=>{
      const statusClass=r.status==='pending'?'request-pending':r.status==='approved'?'request-approved':'request-rejected';
      const statusIcon=r.status==='pending'?'‚è≥':r.status==='approved'?'‚úÖ':'‚ùå';
      const statusText=r.status.toUpperCase();
      return`<div class="request-card ${statusClass}">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
          <strong style="color:var(--text);">${r.coinsRequested} COINS</strong>
          <span style="font-size:10px;padding:3px 8px;border-radius:12px;background:rgba(0,0,0,0.3);">${statusIcon} ${statusText}</span>
        </div>
        <div style="font-size:11px;color:var(--muted);">Amount Sent: ‚Ç±${r.amountSent}</div>
        <div style="font-size:11px;color:var(--muted);">GCash Ref: ${r.gcashRef}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:5px;">${new Date(r.requestDate).toLocaleString()}</div>
      </div>`;
    }).join('');
  }catch(err){
    console.error(err);
  }
}

window.createAccount=async function(e){
  e.preventDefault();
  const u=document.getElementById('new-username').value.trim().toLowerCase();
  const p=document.getElementById('new-password').value;
  const p2=document.getElementById('new-password2').value;
  const initialCoins=parseInt(document.getElementById('initial-coins').value)||0;
  
  if(u.length<3){showStatus('Username must be at least 3 characters.',false,'create-acc-status');return;}
  if(p.length<4){showStatus('Password must be at least 4 characters.',false,'create-acc-status');return;}
  if(p!==p2){showStatus('Passwords do not match.',false,'create-acc-status');return;}
  if(BUILTIN.find(b=>b.username===u)){showStatus('Username already exists.',false,'create-acc-status');return;}
  
  try{
    const snap=await get(ref(db,'accounts'));
    if(snap.exists()&&snap.val()[u]){
      showStatus('Username already exists.',false,'create-acc-status');
      return;
    }
    
    await set(ref(db,`accounts/${u}`),{
      password:p,
      isAdmin:false,
      builtIn:false,
      coins:initialCoins,
      createdDate:new Date().toISOString()
    });
    
    document.getElementById('create-acc-form').reset();
    showStatus('‚úÖ Account "'+u+'" created with '+initialCoins+' coins!',true,'create-acc-status');
    setTimeout(()=>renderAdminPage(),500);
  }catch(err){
    showStatus('Error creating account.',false,'create-acc-status');
  }
};

window.deleteAccount=async function(u){
  if(u===ADMIN_USER){alert('Cannot delete the admin account.');return;}
  if(BUILTIN.find(b=>b.username===u)){alert('Cannot delete built-in accounts.');return;}
  if(!confirm('Delete account "'+u+'" and ALL their data?'))return;
  
  try{
    await Promise.all([
      remove(ref(db,`accounts/${u}`)),
      remove(ref(db,`users/${u}`))
    ]);
    alert('‚úÖ Account "'+u+'" deleted.');
    renderAdminPage();
  }catch(err){
    alert('Error deleting account.');
  }
};

async function renderAdminPage(){
  try{
    const [accountsSnap,usersSnap,requestsSnap]=await Promise.all([
      get(ref(db,'accounts')),
      get(ref(db,'users')),
      get(ref(db,'coinRequests'))
    ]);
    
    let accounts=[...BUILTIN];
    if(accountsSnap.exists()){
      const data=accountsSnap.val();
      accounts=[...accounts,...Object.keys(data).map(k=>({username:k,...data[k]})).filter(a=>!BUILTIN.find(b=>b.username===a.username))];
    }
    
    const pendingReqs=[];
    if(requestsSnap.exists()){
      const data=requestsSnap.val();
      Object.keys(data).forEach(k=>{
        if(data[k].status==='pending')pendingReqs.push({firebaseKey:k,...data[k]});
      });
    }
    pendingReqs.sort((a,b)=>b.requestDate.localeCompare(a.requestDate));
    
    if(pendingReqs.length===0){
      document.getElementById('admin-requests-container').innerHTML='<div class="no-log">No pending requests.</div>';
    }else{
      document.getElementById('admin-requests-container').innerHTML=pendingReqs.map(r=>`<div class="request-card request-pending">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px;align-items:center;">
          <div>
            <strong style="color:var(--text);">${r.username}</strong>
            <span style="margin-left:10px;color:#ffd700;font-weight:700;">${r.coinsRequested} COINS</span>
          </div>
          <span style="font-size:10px;padding:3px 8px;border-radius:12px;background:rgba(255,165,0,0.2);">‚è≥ PENDING</span>
        </div>
        <div style="font-size:11px;color:var(--muted);">Amount: ‚Ç±${r.amountSent} | Ref: ${r.gcashRef}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:5px;margin-bottom:10px;">${new Date(r.requestDate).toLocaleString()}</div>
        <div style="display:flex;gap:8px;">
          <button class="btn-approve" style="flex:1;" onclick="approveCoinRequest('${r.firebaseKey}','${r.username}',${r.coinsRequested})">‚úÖ APPROVE</button>
          <button class="btn-danger-sm" style="flex:1;" onclick="rejectCoinRequest('${r.firebaseKey}')">‚ùå REJECT</button>
        </div>
      </div>`).join('');
    }
    
    const userSelect=document.getElementById('admin-user-select');
    userSelect.innerHTML='<option value="">Select a user...</option>'+accounts.filter(a=>!a.isAdmin).map(a=>`<option value="${a.username}">${a.username} (${a.coins||0} coins)</option>`).join('');
    
    const c=document.getElementById('accounts-container');
    c.innerHTML=accounts.map(ac=>{
      const userPigeons=usersSnap.exists()&&usersSnap.val()[ac.username]&&usersSnap.val()[ac.username].pigeons?Object.values(usersSnap.val()[ac.username].pigeons).length:0;
      const userRaces=usersSnap.exists()&&usersSnap.val()[ac.username]&&usersSnap.val()[ac.username].races?Object.values(usersSnap.val()[ac.username].races).length:0;
      const isSelf=ac.username===currentUser;
      const canDel=!ac.builtIn&&!isSelf;
      return`<div class="account-row">
        <div class="account-info">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div class="account-name">${ac.username}</div>
            <span class="account-badge ${ac.isAdmin?'badge-admin':'badge-user'}">${ac.isAdmin?'üëë Admin':'User'}</span>
            ${isSelf?'<span class="account-badge" style="background:rgba(57,255,20,0.1);color:var(--green);border:1px solid rgba(57,255,20,0.25);">You</span>':''}
            ${!ac.isAdmin?`<span class="coins-display" style="display:inline-flex;padding:3px 8px;">üí∞ ${ac.coins||0}</span>`:''}
          </div>
          <div class="stats-pill">
            <span class="stat-chip">üïäÔ∏è <strong>${userPigeons}</strong> pigeons</span>
            <span class="stat-chip">üèÅ <strong>${userRaces}</strong> events</span>
            ${ac.builtIn?'<span class="stat-chip" style="color:var(--muted);">Built-in</span>':''}
            ${ac.createdDate?'<span class="stat-chip">Created: <strong>'+new Date(ac.createdDate).toLocaleDateString()+'</strong></span>':''}
          </div>
        </div>
        ${canDel?`<button class="btn-danger-sm" onclick="deleteAccount('${ac.username}')">Delete</button>`:'<span style="font-size:10px;color:var(--muted);">Protected</span>'}
      </div>`;
    }).join('');
    
    let totalPigeons=0,totalRaces=0,totalArrivals=0,totalCoins=0;
    accounts.forEach(ac=>{
      if(usersSnap.exists()&&usersSnap.val()[ac.username]){
        const ud=usersSnap.val()[ac.username];
        if(ud.pigeons)totalPigeons+=Object.values(ud.pigeons).length;
        if(ud.races){
          const rs=Object.values(ud.races);
          totalRaces+=rs.length;
          rs.forEach(r=>totalArrivals+=(r.arrivals||[]).length);
        }
      }
      if(!ac.isAdmin)totalCoins+=(ac.coins||0);
    });
    
    document.getElementById('global-stats').innerHTML=`
      <div class="info-row"><span class="info-label">Total Accounts</span><span class="info-value">${accounts.length}</span></div>
      <div class="info-row"><span class="info-label">Total Pigeons (all users)</span><span class="info-value">${totalPigeons}</span></div>
      <div class="info-row"><span class="info-label">Total Events (all users)</span><span class="info-value">${totalRaces}</span></div>
      <div class="info-row"><span class="info-label">Total Arrivals Recorded</span><span class="info-value">${totalArrivals}</span></div>
      <div class="info-row"><span class="info-label">Total Coins in Circulation</span><span class="info-value">${totalCoins} üí∞</span></div>
    `;
  }catch(err){
    console.error(err);
  }
}

window.approveCoinRequest=async function(firebaseKey,username,coins){
  if(!confirm(`Approve ${coins} coins for ${username}?`))return;
  try{
    const accountRef=ref(db,`accounts/${username}`);
    const snap=await get(accountRef);
    const currentCoins=snap.exists()?(snap.val().coins||0):0;
    
    await Promise.all([
      update(accountRef,{coins:currentCoins+coins}),
      update(ref(db,`coinRequests/${firebaseKey}`),{status:'approved',approvedDate:new Date().toISOString()})
    ]);
    
    alert('‚úÖ Approved! '+coins+' coins added to '+username);
    renderAdminPage();
  }catch(err){
    alert('Error approving request.');
  }
};

window.rejectCoinRequest=async function(firebaseKey){
  if(!confirm('Reject this request?'))return;
  try{
    await update(ref(db,`coinRequests/${firebaseKey}`),{status:'rejected',rejectedDate:new Date().toISOString()});
    alert('‚ùå Request rejected.');
    renderAdminPage();
  }catch(err){
    alert('Error rejecting request.');
  }
};

window.adminAddCoins=async function(e){
  e.preventDefault();
  const u=document.getElementById('admin-user-select').value;
  const amt=parseInt(document.getElementById('admin-coins-amount').value);
  const reason=document.getElementById('admin-coin-reason').value.trim();
  
  if(!u){showStatus('Select a user.',false,'admin-coin-status');return;}
  
  try{
    const accountRef=ref(db,`accounts/${u}`);
    const snap=await get(accountRef);
    const currentCoins=snap.exists()?(snap.val().coins||0):0;
    
    await update(accountRef,{coins:currentCoins+amt});
    
    document.getElementById('admin-coin-form').reset();
    showStatus(`‚úÖ ${amt} coins added to ${u}! ${reason?'('+reason+')':''}`,true,'admin-coin-status');
    setTimeout(()=>renderAdminPage(),500);
  }catch(err){
    showStatus('Error adding coins.',false,'admin-coin-status');
  }
};

document.addEventListener('DOMContentLoaded',()=>{
  if(currentUser)initApp();
  setInterval(()=>{autoArchive();renderRaces();renderHistory();},60000);
});
</script>
</body>
</html>
